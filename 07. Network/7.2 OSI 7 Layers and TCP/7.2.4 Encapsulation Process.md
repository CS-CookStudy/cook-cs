# 캡슐화와 역캡슐화 과정 (면접 대비)

## 1. 캡슐화/역캡슐화 정의

### 캡슐화 (Encapsulation)

> 송신자에서 데이터가 상위 계층 → 하위 계층으로 이동하며 **각 계층의 헤더가 추가**되는 과정

### 역캡슐화 (Decapsulation)

> 수신자에서 데이터가 하위 계층 → 상위 계층으로 이동하며 **각 계층의 헤더가 제거**되는 과정

## 2. 캡슐화 과정 (실제 예시)

### HTTP 웹 요청 시나리오

#### 송신 과정 (캡슐화)

```
7. Application:    [HTTP GET /index.html]
                   ↓ (HTTP 헤더 추가)
4. Transport:      [TCP Header | HTTP GET Request] (Segment)
                   ↓ (TCP 헤더 추가: 포트 80, 시퀀스 번호)
3. Network:        [IP Header | TCP Header | HTTP Request] (Packet)
                   ↓ (IP 헤더 추가: 송신/수신 IP 주소)
2. Data Link:      [Ethernet Header | IP Header | TCP Header | HTTP Request | Ethernet Trailer] (Frame)
                   ↓ (MAC 주소, FCS 추가)
1. Physical:       [Electrical/Optical Signals] (Bits)
```

#### 수신 과정 (역캡슐화)

```
1. Physical:       [Electrical/Optical Signals] → Frame 복원
                   ↓
2. Data Link:      [Ethernet Header | IP Header | TCP Header | HTTP Request | Trailer]
                   ↓ (MAC 주소 확인, FCS 검증, Ethernet 헤더 제거)
3. Network:        [IP Header | TCP Header | HTTP Request]
                   ↓ (IP 주소 확인, TTL 처리, IP 헤더 제거)
4. Transport:      [TCP Header | HTTP Request]
                   ↓ (포트 확인, 시퀀스 처리, TCP 헤더 제거)
7. Application:    [HTTP GET Request] → 웹 서버에서 처리
```

## 3. 각 계층별 헤더 정보

### TCP 헤더 (20바이트 기본)

- **포트 번호**: 송신/수신 포트 (각 2바이트)
- **시퀀스 번호**: 데이터 순서 (4바이트)
- **ACK 번호**: 확인 응답 번호 (4바이트)
- **플래그**: SYN, ACK, FIN 등 제어 정보

### IP 헤더 (20바이트 기본)

- **Version**: IP 버전 (4 또는 6)
- **TTL**: 패킷 생존 시간 (홉 제한)
- **Protocol**: 상위 프로토콜 (TCP=6, UDP=17)
- **Source/Dest IP**: 송신/수신 IP 주소 (각 4바이트)

### Ethernet 헤더 (14바이트) + 트레일러 (4바이트)

- **Dest MAC**: 수신자 MAC 주소 (6바이트)
- **Src MAC**: 송신자 MAC 주소 (6바이트)
- **Type**: 상위 프로토콜 타입 (2바이트, 0x0800=IPv4)
- **FCS**: 오류 검출용 체크섬 (4바이트)

## 4. 데이터 단위 변화

| 계층            | 데이터 단위 명칭                       | 포함 내용                |
| --------------- | -------------------------------------- | ------------------------ |
| **Application** | **Data/Message**                       | 원본 애플리케이션 데이터 |
| **Transport**   | **Segment** (TCP) / **Datagram** (UDP) | 포트 번호 + 데이터       |
| **Network**     | **Packet**                             | IP 주소 + Segment        |
| **Data Link**   | **Frame**                              | MAC 주소 + Packet        |
| **Physical**    | **Bits**                               | 전기/광 신호             |

## 5. 오버헤드 계산

### 기본 헤더 크기

```
- Ethernet: 18 bytes (헤더 14 + 트레일러 4)
- IP: 20 bytes
- TCP: 20 bytes
- HTTP: ~100 bytes (평균)
총 오버헤드: 158 bytes
```

### 작은 데이터 전송 시 비효율성

```
예: 1바이트 데이터 전송 시
- 실제 데이터: 1 byte
- 오버헤드: 158 bytes
- 총 전송량: 159 bytes
- 효율성: 0.6% (매우 비효율적)
```

## 6. 실제 통신 과정 추적

### 웹 브라우저 → 웹 서버 요청

1. **사용자**: "www.google.com" 입력
2. **DNS 조회**: 도메인 → IP 주소 변환
3. **TCP 연결**: 3-way handshake로 연결 설정
4. **HTTP 요청**: GET 요청 전송 (캡슐화)
5. **네트워크 전송**: 라우터들을 거쳐 목적지 도달
6. **웹 서버**: 요청 수신 (역캡슐화) 및 응답 처리
7. **HTTP 응답**: 웹 페이지 데이터 전송
8. **브라우저**: 응답 수신 및 페이지 렌더링

## 7. 헤더 처리 방식

### 각 계층별 처리 과정

```
📤 송신 시 (캡슐화):
Application → Transport → Network → Data Link → Physical
(헤더 추가)  (헤더 추가)  (헤더 추가)  (헤더 추가)

📥 수신 시 (역캡슐화):
Physical → Data Link → Network → Transport → Application
         (헤더 제거)  (헤더 제거)  (헤더 제거)
```

### 중간 장비에서의 처리

- **라우터**: 3계층까지만 처리 (IP 헤더 확인 후 라우팅)
- **스위치**: 2계층까지만 처리 (MAC 주소 확인 후 스위칭)
- **허브**: 1계층만 처리 (신호 증폭 및 복사)
