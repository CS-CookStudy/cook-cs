# 7.6.4 DHCP (Dynamic Host Configuration Protocol)

## 1. DHCP 개요

### 정의
DHCP는 **네트워크 호스트에 IP 주소와 네트워크 설정을 자동으로 할당**하는 애플리케이션 계층 프로토콜이다.  
수동으로 IP, 서브넷 마스크, 게이트웨이, DNS 서버를 설정하지 않아도, DHCP 서버가 이를 자동으로 제공한다.

### 주요 특징
- **자동화**: 수동 설정 불필요 → 관리 효율성 향상
- **임대 방식(Lease)**: 일정 시간(IP Lease Time) 동안만 주소 사용
- **중앙 집중 관리**: DHCP 서버가 네트워크 내 주소를 통합 관리
- **UDP 기반**: 포트 67(서버), 68(클라이언트) 사용
- **브로드캐스트 기반**: 초기 통신은 브로드캐스트로 시작

### DHCP vs 정적 IP 할당

| 구분 | DHCP (동적) | 정적 IP |
|------|-------------|---------|
| **설정 방식** | 자동 할당 | 수동 설정 |
| **관리 효율성** | 높음 | 낮음 (대규모 시 어려움) |
| **IP 충돌** | 방지됨 | 수동 관리 필요 |
| **이동성** | 우수 (다른 네트워크에서도 자동) | 제한적 |
| **보안성** | 일반적 | 높음 (고정 주소) |
| **사용 예시** | 일반 사용자, 대부분 기기 | 서버, 프린터 등 |

---

## 2. DHCP 동작 원리 (DORA 과정)

DHCP는 크게 4단계 과정을 통해 클라이언트에 IP를 할당한다. 이를 **DORA**라 한다.

### 상세 과정
```
클라이언트                           DHCP 서버
    │                                   │
1. │ ──── DHCP Discover (브로드캐스트) ──► │
   │ src: 0.0.0.0, dst: 255.255.255.255  │
   │                                   │
2. │ ◄── DHCP Offer ─────────────────── │
   │     "192.168.1.100 사용하세요"      │
   │                                   │
3. │ ──── DHCP Request ─────────────────► │
   │     "192.168.1.100 사용하겠습니다"   │
   │                                   │
4. │ ◄── DHCP Acknowledge ────────────── │
   │     "승인, 24시간 사용 가능"         │
   │                                   │
   IP 할당 완료
```

#### 1) Discover (발견)
- **클라이언트 → 브로드캐스트**
- 출발지 IP: `0.0.0.0`, 목적지 IP: `255.255.255.255`
- "DHCP 서버 있나요?" 메시지

#### 2) Offer (제안)
- **서버 → 클라이언트**
- 사용 가능한 IP 주소와 네트워크 설정 정보 제안
- 임대 시간, 서브넷 마스크, 게이트웨이, DNS 서버 포함

#### 3) Request (요청)
- **클라이언트 → 서버**
- 특정 서버의 제안을 수락하겠다는 요청
- 다른 DHCP 서버들에게는 거절 의미

#### 4) Acknowledge (승인)
- **서버 → 클라이언트**
- IP 임대 승인 및 최종 네트워크 설정 전달
- 클라이언트가 해당 IP 사용 시작

---

## 3. DHCP 메시지 구조

### 주요 필드
- **op**: 요청(1)/응답(2) 구분
- **htype**: 하드웨어 타입 (이더넷=1)
- **chaddr**: 클라이언트 MAC 주소 (하드웨어 식별)
- **yiaddr**: "Your IP Address" (클라이언트에 할당될 IP)
- **siaddr**: DHCP 서버 주소
- **giaddr**: DHCP Relay Agent 주소
- **options**: DHCP 옵션 (서브넷 마스크, 게이트웨이, DNS 등)

### 주요 DHCP 옵션
| 옵션 번호 | 이름 | 설명 |
|-----------|------|------|
| 1 | Subnet Mask | 서브넷 마스크 |
| 3 | Router (Gateway) | 기본 게이트웨이 |
| 6 | DNS Servers | DNS 서버 주소 |
| 15 | Domain Name | 도메인 이름 |
| 51 | IP Address Lease Time | IP 임대 시간 |
| 53 | DHCP Message Type | 메시지 타입 (Discover, Offer 등) |

---

## 4. DHCP 고급 개념

### 1) IP Lease Time (임대 시간)
- **정의**: 클라이언트가 IP 주소를 사용할 수 있는 시간
- **갱신 과정**: 임대 시간의 50% 지점에서 자동 갱신 시도
- **트레이드오프**:
    - 짧은 임대: IP 풀 효율적 사용, 네트워크 트래픽 증가
    - 긴 임대: 안정성 높음, IP 낭비 가능성

### 2) DHCP Reservation (예약)
- **목적**: 특정 MAC 주소에 항상 동일한 IP 할당
- **사용 사례**: 서버, 프린터, 네트워크 장비 등
- **장점**: 정적 IP의 안정성 + DHCP의 관리 편의성

### 3) DHCP Relay Agent
- **문제**: DHCP는 브로드캐스트 기반 → 라우터를 넘나들 수 없음
- **해결**: Relay Agent가 다른 네트워크의 DHCP 요청을 중계
- **동작**: 유니캐스트로 변환하여 DHCP 서버에 전달

```
클라이언트 (192.168.1.0/24) ──► 라우터 (Relay Agent) ──► DHCP 서버 (10.0.0.0/24)
```

### 4) DHCP Snooping
- **목적**: 비인가 DHCP 서버(Rogue DHCP) 차단
- **동작**: 스위치에서 신뢰할 수 있는 DHCP 서버만 허용
- **보안**: DHCP 스푸핑 공격 방지

---

## 5. DHCP 장애 및 문제 해결

### 일반적인 문제들
1. **IP 풀 고갈**: 사용 가능한 IP 주소 부족
2. **DHCP 서버 장애**: 단일 장애점 문제
3. **Rogue DHCP**: 악의적 DHCP 서버로 인한 네트워크 혼란
4. **Relay Agent 문제**: 다른 네트워크 세그먼트에서 IP 할당 실패

### 해결 방안
- **이중화**: 여러 DHCP 서버 운영 (Primary/Secondary)
- **모니터링**: IP 풀 사용률 지속 감시
- **DHCP Snooping**: 스위치 레벨에서 보안 강화
- **로그 분석**: DHCP 로그로 문제 상황 추적

---

## 6. 실제 활용 예시

### 1) 기업 네트워크
- 수천 대 단말기에 자동으로 IP 할당
- VLAN별 IP 범위 분할 관리
- 서버/프린터는 Reservation으로 고정 IP 제공

### 2) 공용 Wi-Fi
- 접속 시 자동으로 네트워크 설정
- 짧은 임대 시간으로 IP 풀 효율성 확보

### 3) 가정 공유기
- 인터넷 연결 시 PC/스마트폰에 자동 IP 제공
- 일반적으로 192.168.1.0/24 대역 사용

### 4) 클라우드/가상화 환경
- VM 생성 시 자동 네트워크 설정
- Container 환경에서 동적 IP 할당

---

## 7. 핵심 요약

- **DHCP = IP 및 네트워크 설정 자동화 프로토콜**
- **DORA 과정**: Discover → Offer → Request → Acknowledge
- **UDP 67(서버)/68(클라이언트) 포트 사용**
- **핵심 개념**: Lease Time, Reservation, Relay Agent, Snooping
- **장점**: 관리 효율성, 사용자 편의성, IP 충돌 방지
- **주의사항**: 단일 장애점, 보안 이슈(Rogue DHCP) 고려 필요
- **현대 네트워크의 필수 서비스**: 거의 모든 네트워크에서 사용